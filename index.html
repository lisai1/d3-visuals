<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
  <link rel="stylesheet" href="css/style.css">
	<title>Document</title>
</head>

<body>

  <div class="group">
    <div class="right-side">
      <input type="date" name="" id="bc-to-date"><br><br>
      <span style="position:relative;left:75px;">
        <input type="checkbox" class="bc-cb" id="bc-1a" checked>1a</checkbox>
        <input type="checkbox" class="bc-cb" id="bc-1b" checked>1b</checkbox>
        <input type="checkbox" class="bc-cb" id="bc-1c" checked>1c</checkbox><br><br>
        <input type="checkbox" class="bc-cb" id="bc-2a" checked>2a</checkbox>
        <input type="checkbox" class="bc-cb" id="bc-2b" checked>2b</checkbox>
        <input type="checkbox" class="bc-cb" id="bc-2c" checked>2c</checkbox>
      </span><br><br>
      <span style="position:relative;left:75px;">
        <input type="date" id="start-date-1" class="line-from" min="2015-08-17" value="2015-08-17"><br><br>
        <input type="date" id="end-date-1" class="line-to"  min="2015-08-17"><br><br>
        <input type="range" id="ptile-start" class="percentile" max="100" min="0" value="0"><span class="ptile-start-show">>=0%</span>
        <br><button id="start-end-show">Start-End</button>
      </span>

    </div>
    <div id="bc-visual">
    </div>
  </div>

  <div class="group">
    <div class="right-side">
      <div id="line-radio-group">
        <input type="radio" name="ftype" value="start">Start of Time
        <input type="radio" name="ftype" value="first" checked>First Time
        <br><br>
      </div>
      <button id='all-button' class="line-chart-button">ALL</button>
      <button id='lc-1a' class="line-chart-button">1a</button>
      <button id='lc-1b' class="line-chart-button">1b</button>
      <button id='lc-1c' class="line-chart-button">1c</button>
      <button id='lc-2a' class="line-chart-button">2a</button>
      <button id='lc-2b' class="line-chart-button">2b</button>
      <button id='lc-2c' class="line-chart-button">2c</button><br><br>
      <button id='lc-clear' class="line-chart-button">Clear</button><br><br>
      <input type="date" class="line-from" min="2015-08-17" value="2015-08-17"><br><br>
      <input type="date" class="line-to"  min="2015-08-17"><br><br>
      <select name="lineNameSel" id="line-name-select"></select><br><br>
      <input type="text" id="line-name" placeholder="type name, press enter"><br><br>
    <div id="line-chart-names-display"></div>

    </div>
    <div id="lc-visual">
       <svg id="#line-svg">
       </svg>
    </div>
    <div id="auto-line-chart-names-display"></div>
  </div>

  <br>

</body>

<script type="text/javascript" src="js/jquery-2.2.0.min.js"></script>
<script src="js/d3.min.js"></script>
<script>

var colors = ["#D24D57", "#F22613", "#D91E18", "#96281B", "#EF4836", "#D64541", "#C0392B", "#CF000F", "#E74C3C", "#DB0A5B", "#F64747", "#D2527F", "#E08283", "#F62459", "#E26A6A", "#663399", "#674172", "#AEA8D3", "#913D88", "#9A12B3", "#BF55EC", "#BE90D4", "#8E44AD", "#9B59B6", "#446CB3", "#4183D7", "#59ABE3", "#81CFE0", "#52B3D9", "#22A7F0", "#3498DB", "#2C3E50", "#19B5FE", "#336E7B", "#22313F", "#6BB9F0", "#1E8BC3", "#3A539B", "#34495E", "#67809F", "#2574A9", "#1F3A93", "#89C4F4", "#4B77BE", "#5C97BF", "#4ECDC4", "#87D37C", "#90C695", "#26A65B", "#03C9A9", "#68C3A3", "#65C6BB", "#1BBC9B", "#1BA39C", "#66CC99", "#36D7B7", "#86E2D5", "#2ECC71", "#16a085", "#3FC380", "#019875", "#03A678", "#4DAF7C", "#2ABB9B", "#00B16A", "#1E824C", "#049372", "#26C281", "#F89406", "#EB9532", "#E87E04", "#F4B350", "#F2784B", "#EB974E", "#F5AB35", "#D35400", "#F39C12", "#F9690E", "#F9BF3B", "#F27935", "#E67E22"];

startDate = $('.line-from').val();
endDate = new Date().toISOString().slice(0,10);
$('.line-to').attr('max', endDate);
$('.line-to').attr('max', endDate);
$('.line-from').attr('max', endDate);
$('.line-to').attr('value', endDate);

data = $('#json-dump').html();
$('#json-dump').remove();

maparr = {};
map = {};
sortable = [];
maxdays = -1;
data

$.getJSON( "data.json", function(datum) {
  function histoMap() {
    maparr = {};
    map = {};
    data = datum;

    for (var i = 0; i < data.length; i++) {
        var names = data[i].names.split(', '); //split the CSVs
        for (var j = 0; j < names.length; j++) {
          names[j] = names[j].trim() + '(' + data[i].section + ')';
          map[names[j]] = (map[names[j]] || 0) + 1;
        }
        if (i != 0 && data[i].date != data[i - 1].date) {
          maparr[data[i].date] = map;
        }
    }
    sortable = [];
    for (var name in map) {
      sortable.push([name, map[name]]);
      maxdays = Math.max(maxdays, map[name]);
    }
    sortable.sort(function(a, b) {return a[0].localeCompare(b[0])});
  }

  histoMap();
  barCharInit();
  LineChartInit();

});

function barCharInit() {

  var margin = {top: 30, right: 30, bottom: 30, left: 30};
  var height = 500 - margin.top - margin.bottom,
      width = 975 - margin.left - margin.right;

  var yScale = d3.scale.linear()
                .domain([0, d3.max(sortable, function(d) {
                  return d[1];
                })])
                .range([0, height]);

  var xScale = d3.scale.ordinal()
                .domain(d3.range(0, sortable.length))
                .rangeBands([0, width], 0);

  var colors = d3.scale.linear()
                  .domain([0, sortable.length * .33, sortable.length * .66, sortable.length])
                  .range(['#B58929', '#C61C6F', '#268BD2', '#85992C']);

  var tooltip = d3.select('body').append('div')
                  .attr('class', 'bc-tooltip');

  barchart = d3.select('#bc-visual').append('svg')
    .attr('id', 'bc-chart')
    .attr('width', margin.left + width + margin.right)
    .attr('height', margin.top + height + margin.bottom)
    .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.right + ')')
    .style('background', '#C9D7D6')
    .selectAll('rect').data(sortable)
    .enter().append('rect')
    .style('fill', function(d, i) {
      return colors(i);
    })
    .attr('class', function(d, i) {
      return d[0].substring(d[0].length - 3, d[0].length - 1).split('').reverse().join('');
    })
    .attr('width', xScale.rangeBand())
    .attr('height', 0)
    .attr('x', function(d, i) {
      return xScale(i);
    })
    .attr('y', height)
    .on('mouseover', function(d) {
      tooltip.style('display', '');
      tooltip.html(d + ',' + Math.round(d[1] * 100 / maxdays) + '%')
        .style('left', (d3.event.pageX + 3) + 'px')
        .style('top', (d3.event.pageY) + 'px');
    })
    .on('mouseout', function(d) {
      tooltip.style('display', 'none');
    });

    barchart.transition()
      .attr('height', function(d) {
        return yScale(d[1]);
      })
      .attr('y', function(d) {
        return height - yScale(d[1]);
      })
      .delay(function(d, i) {
        return i * 10;
      });

  var vGuideScale = d3.scale.linear()
    .domain([0, d3.max(sortable, function(d) {
      return d[1];
    })])
    .range([height, 0]);

    var vAxis = d3.svg.axis()
                  .scale(vGuideScale)
                  .orient('left')
                  .ticks(10);

    var vGuide = d3.select('#bc-chart').append('g')
        vAxis(vGuide)
        vGuide.attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
        vGuide.selectAll('path')
              .style({fill: 'none', stroke: '#000'})
        vGuide.selectAll('line')
              .style({stroke: '#000'});

    var hAxis = d3.svg.axis()
                  .scale(xScale)
                  .orient('bottom')
                  .tickValues(xScale.domain().filter(function(d, i) {
                    return !(i % 10);
                  }));

    var hGuide = d3.select('#bc-chart').append('g')
        hAxis(hGuide)
        hGuide.attr('transform', 'translate(' + margin.left + ',' + (height + margin.top) + ')')
        hGuide.selectAll('path')
              .style({fill: 'none', stroke: '#000'})
        hGuide.selectAll('line')
              .style({stroke: '#000'});

  $(".bc-cb").change(function(event) {
      var cbclass = (event.target.id).substring(3, 5).split('').reverse().join('');
      if(!this.checked) {
          // d3.selectAll('rect.' + cbclass).transition().attr('height', 0);
          d3.selectAll('rect.' + cbclass).classed({'bar-shrunk': true});
      } else {
          var rects = d3.selectAll('#bc-visual rect');
          d3.selectAll('rect.' + cbclass).classed({'bar-shrunk': false});
      }
    });

  $(".percentile").change(function() {
    var ptileValue = $(this).val();
    $('.ptile-start-show').html('>=' + ptileValue + '%');
    barchart.transition()
      .attr('height', function(d) {
        if (Math.round(d[1] * 100 / maxdays) >= ptileValue) {
          return yScale(d[1]);
        } else {
          return 0;
        }
      })
      .attr('y', function(d) {
        return height - yScale(d[1]);
      })
      .ease('elastic')
      .delay(function(d, i) {
        return i * 8;
      });
  });

  function barChart() {
    maxdays = -1;
    for (var i = 0; i < sortable.length; i++) {
      sortable[i][1] = 0;
      // console.log(sortable[i][0]);
      for (var j = data.length - 1; j >= 0; j--) {
        if (data[j].date > endDate) {
          break;
        }
        if (data[j].date >= startDate) {
          if ((data[j].names).indexOf((sortable[i][0]).substring(0, (sortable[i][0]).indexOf('('))) >= 0) {
            sortable[i][1]++;
          }
        }
      }
      maxdays = Math.max(maxdays, sortable[i][1]);
    }

    barchart.transition()
      .attr('height', function(d) {
        if (Math.round(d[1] * 100 / maxdays) >= $(".percentile").val()) {
          return yScale(d[1]);
        } else {
          return 0;
        }
      })
      .attr('y', function(d) {
        return height - yScale(d[1]);
      })
      .ease('elastic')
      .delay(function(d, i) {
        return i * 8;
      });

  }

  $('.line-from').change(function() {
    startDate = $(this).val();
    $('.line-from').attr('value', startDate);
    $('#start-date-1').attr('value', startDate);
    barChart();
  });

  $('.line-to').change(function() {
    endDate = $(this).val();
    $('.line-to').attr('value', endDate);
    $('#end-date-1').attr('value', endDate);
    barChart();
  });

}

function hasClass(element, cls) {
    return (' ' + element.className + ' ').indexOf(' ' + cls + ' ') > -1;
}


function LineChartInit() {
  $('#line-name').focus();
  $('#line-name').on('keyup', function(event) {
    if (event.which == 38) {
      if (historyIndex != -1) {
        $(this).val(keyHistory[historyIndex]);
        historyIndex--;
      }
    } else if (event.which == 40) {
      if (historyIndex != keyHistory.length - 1) {
        historyIndex++;
        $(this).val(keyHistory[historyIndex]);
      } else {
        $(this).val('');
      }
    }
    if (event.which == 13) {

      if (startDate > endDate) {
        return ;
      }

      var name = $(this).val().trim();
      $(this).val('');
      if (name.localeCompare('') == 0) {
        return ;
      }
      nameRep = name.replace(' ', '-');
      if (nameList[nameRep] === undefined) {
        lineChart(name);
        keyHistory.push(name);   historyIndex = keyHistory.length - 1;
        if (found) {
          nameList[name.replace(' ', '-')] = 1;
          $('#line-chart-names-display').append($('<span></span>').attr('id', (name.replace(' ', '-') + '-display')).addClass('line-chart-name').html(name).css('background-color', thisColor));
          var lastDiv = $('.line-chart-name').last()
          lastDiv.on('mouseover', function(event) {
            var lineid = '#' + (event.target.id).substring(0, (event.target.id).indexOf('-display'));
            d3.select('path' + lineid).attr("stroke-width", 7);
          });
          lastDiv.on('mouseout', function(event) {
            var lineid = '#' + (event.target.id).substring(0, (event.target.id).indexOf('-display'));
            d3.select('path' + lineid).attr("stroke-width", 2);
          });
          lastDiv.on('click', function (event) {
            var lineid = (event.target.id).substring(0, (event.target.id).indexOf('-display'));
            $(this).addClass('hidden');
            d3.select('g#g-' + lineid).classed({'hidden': true});
            d3.select('path#' + lineid).attr("stroke-width", 2);
            // console.log(lineid);
            nameList[((event.target.id).substring(0, (event.target.id).indexOf('-display')))] = 0;
          });
        }
      } else if (nameList[nameRep] === 0) {
        nameList[nameRep] = 1;
        d3.select('g#g-' + nameRep).classed({'hidden': false});
        $('#' + nameRep + '-display').removeClass('hidden');
      }
    }
  });

    ftype = 'first';
    $('input[type=radio][name=ftype]').change(function() {
        ftype = this.value;
        lineClear();
    });

    var select = $('#line-name-select')
    for (var i = 0; i < sortable.length; i++) {
      var attach = (sortable[i][0]).substring(0, (sortable[i][0]).indexOf('('));
      select.append($("<option/>").attr("value", attach).text(attach));
    }

    $('#line-name-select').change(function () {
      $('#line-name').val($(this).val()).trigger(jQuery.Event('keyup', {which: 13}));
    });

    $('.line-from').change(function() {
      lineClear();
      xAxisChange();
    });

    $('.line-to').change(function() {
      lineClear();
      xAxisChange();
    });

    function xAxisChange() {
      xScale = d3.time.scale().domain([parseDate(startDate), parseDate(endDate)]).range([0, width]);
      hAxis = d3.svg.axis().scale(xScale).orient('bottom').ticks(10);
      d3.select('g#x-axis').remove();
      hGuide = svgContainer.append('g').call(hAxis).attr('id', 'x-axis').attr('transform', 'translate(' + margin.left + ',' + (margin.top + height) + ')');
      hGuide.selectAll('path').style({fill: 'none', stroke: '#000'})
    hGuide.selectAll('line').style({stroke: '#000'});
    }

    keyHistory = [];
    historyIndex = -1;
    nameList = {};
    var found;

    var margin = {top: 40, right: 40, bottom: 40, left: 40};
    var height = 660 - margin.top - margin.bottom,
         width = 950 - margin.left - margin.right;

    var parseDate = d3.time.format("%Y-%m-%d").parse;

    var yScale = d3.scale.linear().domain([0, 100]).range([height, 0]);
    var xScale = d3.time.scale().domain([parseDate(data[data.length - 1].date), parseDate(data[0].date)]).range([0, width]);

    var svgContainer = d3.select("#lc-visual").select("svg").attr("width", margin.right + width + margin.left).attr("height", margin.bottom + height + margin.top);

    var ribbonGroup = svgContainer.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')').attr('height', height).attr('width', width);
    ribbonGroup.append('rect').attr('x', 0).attr('y', 0).attr('height', 3 * height / 20).attr('width', width).attr('fill', 'red').style({opacity:'0.2'});
    ribbonGroup.append('rect').attr('x', 0).attr('y', 3 * height / 20).attr('height', 4 * height / 20).attr('width', width).attr('fill', '#F7CA18').style({opacity:'0.2'});
    ribbonGroup.append('rect').attr('x', 0).attr('y', 7 * height / 20).attr('height', 6 * height / 20).attr('width', width).attr('fill', '#1F3A93').style({opacity:'0.2'});
    ribbonGroup.append('rect').attr('x', 0).attr('y', 13 * height / 20).attr('height', 4 * height / 20).attr('width', width).attr('fill', '#00B16A').style({opacity:'0.2'});
    ribbonGroup.append('rect').attr('x', 0).attr('y', 17 * height / 20).attr('height', 3 * height / 20).attr('width', width).attr('fill', 'grey').style({opacity:'0.2'});

    var vAxis = d3.svg.axis().scale(yScale).orient('left').ticks(10);
    var hAxis = d3.svg.axis().scale(xScale).orient('bottom').ticks(10);

    var hGuide = svgContainer.append('g').call(hAxis).attr('id', 'x-axis').attr('transform', 'translate(' + margin.left + ',' + (margin.top + height) + ')');
    hGuide.selectAll('path').style({fill: 'none', stroke: '#000'})
    hGuide.selectAll('line').style({stroke: '#000'});

    var vGuide = svgContainer.append('g').call(vAxis).attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
    vGuide.selectAll('path').style({fill: 'none', stroke: '#000'})
    vGuide.selectAll('line').style({stroke: '#000'});

  function lineChart(name) {

    if (startDate > endDate) {
      return ;
    }
    thisColor = colors[Math.floor((Math.random() * (colors.length - 1)) + 1)];

    found = false;
    lineMap = {};

    var i = data.length - 1;
    while (data[i].date < startDate) {
      i--;
    }
    lineMap[data[i].date] = 0;  var firstDate = true;
    for (; i >= 0; i--) {
      if (data[i].date > endDate) {
        break;
      }
      if (!firstDate) {
        lineMap[data[i].date] = lineMap[data[i + 1].date];
      }
      if (data[i].names.toLowerCase().indexOf(name.toLowerCase()) > -1) {
        lineMap[data[i].date]++;
        found = true;
      }
      firstDate = false;
    }

    if (!found) {
      return ;
    }

    lineData = [];
    i = 0;
    for (key in lineMap) {
      if (lineMap[key] == 0 && ftype === "first") {
        continue;
      }
      i++;
      lineData.push([parseDate(key), (lineMap[key] * 100) / i]);
    }
    // console.log(lineData);

    var lineFunction = d3.svg.line()
                        .x(function(d, i) { return xScale(d[0]); })
                        .y(function(d, i) { return yScale(d[1]); })
                        .interpolate("linear");

    var tooltip = d3.select("body")
            .append("div")  // declare the tooltip div 
            .attr("class", "bc-tooltip")
            .style({color:thisColor});

    var svgGroup = svgContainer.append('g').attr('class', 'line-class').attr('id', 'g-' + name.replace(' ', '-')).attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var lineGraph = svgGroup.append("path")
                            .attr("id", name.replace(' ', '-'))
                            .attr("d", lineFunction(lineData))
                            .attr("stroke", thisColor)
                            .attr("stroke-width", 2)
                            .attr("fill", "none")
                            .on("mouseover", function() {
                                d3.select('path#' + name.replace(' ', '-')).attr("stroke-width", 6);
                                tooltip.style('display', '');
                                tooltip.html(name).style('left', (d3.event.pageX + 3) + 'px').style('top', (d3.event.pageY) + 'px');
                            })
                            .on("mouseout", function() {
                               d3.select('path#' + name.replace(' ', '-')).attr("stroke-width", 2);
                               tooltip.style('display', 'none');
                            });
    grshrk = 0;                    
    clearInterval(grshrk);
    grshrk = setInterval(function() {
        svgGroup.selectAll("circle")
                .transition().duration(500).ease('quad').attr('r', 6)
                .transition().duration(500).ease('quad').attr('r', 5);
    }, 10000);

    var totalLength = lineGraph.node().getTotalLength();

    lineGraph
      .attr("stroke-dasharray", totalLength + " " + totalLength)
      .attr("stroke-dashoffset", totalLength)
      .transition()
      .duration(3500)
      .ease("quad")
      .attr("stroke-dashoffset", 0);


       svgGroup.selectAll("circle")                                    
          .data(lineData)
          .enter().append("circle")                            
          .attr("r", 12)    
          .attr("cx", function(d, i) { return xScale(d[0]); })
          .attr("cy", function(d, i) { return yScale(d[1]); })// - yScale(d[1] * 100 / (i + 1)); })
           // Tooltip stuff after this
          .style({stroke:'#fff', fill:'#fff'})
          .on("mouseover", function(d) {
            d3.select('path#' + name.replace(' ', '-')).attr("stroke-width", 5);
            tooltip.style('display', '');
            tooltip.html(dateFormat(d[0]) + ', ' + parseInt(d[1]) + '%')
              .style('left', (d3.event.pageX + 3) + 'px')
              .style('top', (d3.event.pageY) + 'px');
          })
          .on("mouseout", function(d, i) {
              tooltip.style('display', 'none');
              d3.select('path#' + name.replace(' ', '-')).attr("stroke-width", 2);
          });;

        svgGroup.selectAll("circle")
                .transition()
                .duration(3000)
                .ease('elastic')
                .style({stroke:thisColor})
                .attr('r', 5);
  }

  $('.line-chart-button').click(function(event) {
    if (event.target.id === 'lc-clear') {
      lineClear();
      return ;
    }
    $('#line-radio-group > input:radio').attr('disabled', 'true');
    var i = 0;
    $('#' + event.target.id).attr('disabled', true);
    console.log(event.target.id);
    var tid = (event.target.id).substring((event.target.id).indexOf('-') + 1);
    if (tid === 'button') {
      tid = '';
    }
    var t = setInterval(function() {
      if (i >= sortable.length) {
        $('#line-radio-group > input:radio').removeAttr('disabled');
        clearInterval(t);
        return;
      }
      if ((sortable[i][0]).indexOf(tid) >= 0) {
        lineChart((sortable[i][0]).substring(0, (sortable[i][0]).length - 4));
        $('#auto-line-chart-names-display').append($('<span></span>').attr('title', sortable[i][0]).attr('id', ((sortable[i][0]).substring(0, (sortable[i][0]).length - 4)).replace(' ', '-') + '-display').addClass('line-chart-name-auto').html((sortable[i][0]).substring(0,6) + '..').css('background-color', thisColor));
        var lastDiv = $('.line-chart-name-auto').last();
          lastDiv.on('mouseover', function(event) {
            var lineid = '#' + (event.target.id).substring(0, (event.target.id).indexOf('-display'));
            d3.select('path' + lineid).attr("stroke-width", 7);
          });
          lastDiv.on('mouseout', function(event) {
            var lineid = '#' + (event.target.id).substring(0, (event.target.id).indexOf('-display'));
            d3.select('path' + lineid).attr("stroke-width", 2);
          });
          lastDiv.on('click', function(event) {
            var lineid = (event.target.id).substring(0, (event.target.id).indexOf('-display'));
            $(this).addClass('hidden');
            d3.select('g#g-' + lineid).remove();
            d3.select('path#' + lineid).attr("stroke-width", 2);
            nameList[((event.target.id).substring(0, (event.target.id).indexOf('-display')))] = 0;
          });
      }
      i++;
    }, 100);
  });

  function lineClear() {
    d3.select("#lc-visual").select("svg").selectAll('g.line-class').remove();
      $('#line-chart-names-display').html('');
      $('#auto-line-chart-names-display').html('');
      $('.line-chart-button').removeAttr('disabled');
      nameList = {};
  }
}

function dateFormat(date) {
  var date = new Date(date);
  var dateNum = date.getDate();
  var day = date.getDay(); //returns 0 - 6
  var month = date.getMonth(); //returns 0 - 11
  var year = date.getFullYear(); //returns 4 digit year ex: 2000

  switch (day) {
    case 0: day = "Sun";
        break;
    case 1: day = "Mon";
        break;
    case 2: day = "Tue";
        break;
    case 3: day = "Wed";
        break;
    case 4: day = "Thu";
        break;
    case 5: day = "Fri";
        break;
    case 6: day = "Sat";
        break;
  }

  switch (month) {
    case 0: month = "Jan";
        break;
    case 1: month = "Feb";
        break;
    case 2: month = "Mar";
        break;
    case 3: month = "Apr";
        break;
    case 4: month = "May";
        break;
    case 5: month = "Jun";
        break;
    case 6: month = "Jul";
        break;
    case 7: month = "Aug";
        break;
    case 8: month = "Sept";
        break;
    case 9: month = "Oct";
        break;
    case 10: month = "Nov";
        break;
    case 11: month = "Dec";
        break;
  }

  return day + " " + month + " " + dateNum + " " + year;
  }


  $('#start-end-show').click(function() {
    alert("Start Date is " + startDate + "\nEnd Date is " + endDate);
  });

</script>

</html>
